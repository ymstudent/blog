---
title: "redis命令请求的执行过程"
date: 2021-01-21T22:35:06+08:00
draft: false
tags: ["redis"]
keywords: ["redis", "命令请求执行过程"]
---

### 发送命令请求

当用户在客户端键入一个命令请求时，客户端会将这个命令请求转化成协议格式，然后通过连接到服务器的套接字，将协议格式的命令请求发送给服务器。

```
eg : SET KEY VALUE
协议转化后： *3\r\n$3\r\nSET\r\nKEY\r\nVALUE\r\n
```

### 读取命令请求

客户端与服务器之间的连接套接字，因为客户端的写入操作而产生 AE_READABLE 事件，这时服务器会调用命令请求处理器来执行以下操作：

* 1) 读取套接字中协议格式的命令请求，并将其保存到客户端状态的输入缓冲区中

* 2) 对输入缓冲区的命令请求进行分析，将分析出的参数和参数个数保存到客户端的 argv 与 argc 属性中

### 命令执行器处理命令请求

在完成参数分析后，服务器会根据参数执行指定命令。命令执行的过程又分为以下几个阶段：

* 1) 查找命令实现：根据 argv[0] 参数去命令表（command table）中查找对应的命令，然后将客户端状态的 cmd 指针指向这个命令

* 2) 执行预备操作：在命令执行前，服务器会进行以下检查， 一旦有一个条件未满足，命令都不会被执行

	* 检查客户端的 cmd 指针是否指向 NULL

	* 检查命令请求所给的的参数个数是否正确

	* 检查客户端是否已通过身份验证

	* 检查服务器内存情况

	* 检查命令是否具备执行条件

* 3) 调用命令的实现函数：命令实现函数会执行指定操作，产生相应回复，并将这些回复保存在客户端状态的输出缓冲区中，然后将客户端的套接字关联命令回复处理器，等待套接字产生 AE_WRITEABLE 事件

* 4) 执行后续工作：在命令执行完成后，服务器会进行一些后续的处理

	* 检查是否开启慢查询日志，如果开启，判断是否需要向慢查询日志中添加一条记录

	* 更新 redisCommand 结构的 milliseconds 属性和 calls 计数器

	* 检查是否开启AOF持久化，如开启，向AOF缓冲区中添加一条记录

	* 检查是否有从服务器正在复制当前服务器，如果有，将刚执行的命令广播给这些从服务器

### 将命令请求发送给客户端

套接字产生 AE_WRITEABLE 事件后，服务器将命令回复发送给客户端，然后情况客户端的输出缓冲区，等待下一个命令请求。

### 客户端接受并打印命令回复

客户端接受到协议格式的回复后，将回复转化为可读格式输出。