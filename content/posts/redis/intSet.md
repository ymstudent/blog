---
title: "redis数据结构之整数集合"
date: 2020-12-19T23:04:04+08:00
draft: false
tags: ["redis"]
keywords: ["redis", "设计与实现", "整数集合", "intSet"]
---

整数集合是Reids集合键的底层实现之一，**它可以保存类型为int16_t, int32_t或者int64_t的整数值，并且保证集合中不会出现重复元素**。

### Redis整数集合的实现

```
typedef struct inset {
	//编码方式, 决定contents数组的类型
	uint32_t encoding ;
	//集合包含的元素数量
	uint32_t length ;
	//保存元素的数组，里面的元素从小到大有序排列，且不包含任何重复项
	int8_t contents[] ;
} inset ;
```



### 升级操作

如果要将一个新元素加入到整数集合中，且这个新元素的类型比整数集合现有所有元素的类型都要长时，整数集合需要先进行升级，才能将新元素添加到集合中。

升级整数集合并添加新元素共分为三步进行：

* 根据新元素的类型，扩展底层数组的空间大小，并为新元素分配空间

* 将底层数组现有的所有元素都转化为新元素相同的类型，并将类型转换后的元素放置到正确的位上

* 将新元素添加到底层数组中（新元素要么比所有元素都大，要么比所有元素都小，所以不是放在数组的第一位就是放在数组的最后一位）

因为每次向整数集合中添加新元素都可能会引起升级，而每次升级操作都需要对底层数组中已有的所有元素进行类型转换，所以向整数集合添加新元素的时间负责度为O(N)。

### 升级操作的好处

* 提升灵活性：可以随意的将int16_t, int32_t, int64_t类型的整数添加到集合中，而不必担心出现类型错误

* 节约内存

### 降级

整数集合不支持降级操作，一旦对数组进行升级后，编码就会保持升级后的状态。